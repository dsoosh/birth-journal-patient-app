stages:
  - test
  - build

variables:
  FLUTTER_VERSION: "3.24.0"
  PUB_CACHE: "$CI_PROJECT_DIR/.pub-cache"

cache:
  paths:
    - .pub-cache/
    - .dart_tool/

test:
  stage: test
  image: ghcr.io/cirruslabs/flutter:${FLUTTER_VERSION}
  before_script:
    - flutter --version
    - flutter pub get
  script:
    - flutter test --coverage --reporter expanded
    - flutter test --coverage --machine > test-results.json || true
  coverage: '/lines\.*: \d+\.\d+%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura.xml
    paths:
      - coverage/
      - test-results.json
    expire_in: 30 days
  only:
    - merge_requests
    - main
    - develop

analyze:
  stage: test
  image: ghcr.io/cirruslabs/flutter:${FLUTTER_VERSION}
  before_script:
    - flutter --version
    - flutter pub get
  script:
    - flutter analyze --no-fatal-infos
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

format:
  stage: test
  image: ghcr.io/cirruslabs/flutter:${FLUTTER_VERSION}
  before_script:
    - flutter --version
  script:
    - dart format --set-exit-if-changed .
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

build-apk:
  stage: build
  image: ghcr.io/cirruslabs/flutter:${FLUTTER_VERSION}
  before_script:
    - flutter --version
    - flutter pub get
  script:
    - flutter build apk --debug --dart-define API_BASE_URL=https://api.example.com/api/v1
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/app-debug.apk
    expire_in: 7 days
  only:
    - merge_requests
    - main
    - develop

build-web:
  stage: build
  image: ghcr.io/cirruslabs/flutter:${FLUTTER_VERSION}
  before_script:
    - flutter --version
    - flutter pub get
  script:
    - flutter build web --dart-define API_BASE_URL=https://api.example.com/api/v1
  artifacts:
    paths:
      - build/web/
    expire_in: 7 days
  only:
    - merge_requests
    - main
    - develop
